name: Deploy to GitHub Pages

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      ready: ${{ steps.deployment_status.outputs.ready }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check if package.json exists
      id: check_package
      run: |
        if [ -f "package.json" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "✅ package.json found. Proceeding with build."
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "⚠️ package.json not found. Skipping build steps."
        fi
    
    - name: Setup Node.js
      if: steps.check_package.outputs.exists == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      if: steps.check_package.outputs.exists == 'true'
      run: npm ci
    
    - name: Build for static export
      if: steps.check_package.outputs.exists == 'true'
      run: npm run build
      env:
        NEXT_PUBLIC_BASE_PATH: /bookish-waffle
        NEXT_PUBLIC_PRIVY_APP_ID: ${{ secrets.NEXT_PUBLIC_PRIVY_APP_ID }}
        NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID }}
    
    - name: Setup Pages
      if: steps.check_package.outputs.exists == 'true'
      uses: actions/configure-pages@v4
    
    - name: Upload artifact
      if: steps.check_package.outputs.exists == 'true'
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./out
    
    - name: Skip deployment (no package.json)
      if: steps.check_package.outputs.exists == 'false'
      run: |
        echo "⚠️ package.json not found. Skipping deployment."
        echo "Next.js project needs to be initialized first."
        echo "Workflow will automatically run once project is set up."
        echo "This is expected behavior during the planning/documentation phase."
    
    - name: Set deployment status
      id: deployment_status
      run: |
        if [ "${{ steps.check_package.outputs.exists }}" == "true" ]; then
          echo "ready=true" >> $GITHUB_OUTPUT
        else
          echo "ready=false" >> $GITHUB_OUTPUT
        fi
    
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: needs.build.outputs.ready == 'true' && needs.build.result == 'success'
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

